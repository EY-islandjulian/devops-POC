name: Automated File Organization

on:
  workflow_dispatch:
    inputs:
      folder_name:
        description: 'Folder to organize'
        required: true
        default: 'myfolder'  # Default folder name, can be overridden by user input

jobs:
  organize-files:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Grant write access to the repository contents
    env:
      TARGET_FOLDER: ${{ github.event.inputs.folder_name }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Git user
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"

    - name: Print current directory
      run: |
        echo "Current working directory:"
        pwd  # Show the current directory to confirm we're at the root of the repo
        echo "Listing files in current directory:"
        ls -la  # List files at the root of the repository

    - name: Organize files in a specific folder
      run: |
        echo "Organizing files in folder: $TARGET_FOLDER"
        
        # Create subfolders inside the target folder if they don't exist
        mkdir -p "$TARGET_FOLDER/Technical_Design" "$TARGET_FOLDER/Functional_Design" "$TARGET_FOLDER/Scripts" "$TARGET_FOLDER/CMA"
        
        # Debug: Verify the contents of the target folder before moving files
        echo "Listing contents of $TARGET_FOLDER before moving files:"
        ls "$TARGET_FOLDER"
        
        # Move TD files that are not in subfolders
        echo "Moving TD files"
        files=$(find "$TARGET_FOLDER" -maxdepth 1 -type f -name '*TD*')
        echo "Found TD files: $files"
        
        for file in $files; do
          # Check if the file already exists in the target subfolder
          if [ -f "$TARGET_FOLDER/Technical_Design/$(basename $file)" ]; then
            echo "File $(basename $file) exists in Technical_Design. Replacing it."
            mv -f "$file" "$TARGET_FOLDER/Technical_Design/"  # Replace the existing file
          else
            echo "File $(basename $file) does not exist in Technical_Design. Moving it."
            mv "$file" "$TARGET_FOLDER/Technical_Design/"  # Move the new file
          fi
        done

        # Move FD files that are not in subfolders
        echo "Moving FD files"
        files=$(find "$TARGET_FOLDER" -maxdepth 1 -type f -name '*FD*')
        echo "Found FD files: $files"
        
        for file in $files; do
          # Check if the file already exists in the target subfolder
          if [ -f "$TARGET_FOLDER/Functional_Design/$(basename $file)" ]; then
            echo "File $(basename $file) exists in Functional_Design. Replacing it."
            mv -f "$file" "$TARGET_FOLDER/Functional_Design/"  # Replace the existing file
          else
            echo "File $(basename $file) does not exist in Functional_Design. Moving it."
            mv "$file" "$TARGET_FOLDER/Functional_Design/"  # Move the new file
          fi
        done

        # Move cm* files that are not in subfolders
        echo "Moving cm* files"
        files=$(find "$TARGET_FOLDER" -maxdepth 1 -type f -name 'cm*')
        echo "Found cm* files: $files"
        
        for file in $files; do
          # Check if the file already exists in the target subfolder
          if [ -f "$TARGET_FOLDER/Scripts/$(basename $file)" ]; then
            echo "File $(basename $file) exists in Scripts. Replacing it."
            mv -f "$file" "$TARGET_FOLDER/Scripts/"  # Replace the existing file
          else
            echo "File $(basename $file) does not exist in Scripts. Moving it."
            mv "$file" "$TARGET_FOLDER/Scripts/"  # Move the new file
          fi
        done

        # Move .cma files that are not in subfolders
        echo "Moving .cma files"
        files=$(find "$TARGET_FOLDER" -maxdepth 1 -type f -name '*.cma')
        echo "Found .cma files: $files"
        
        for file in $files; do
          # Check if the file already exists in the target subfolder
          if [ -f "$TARGET_FOLDER/CMA/$(basename $file)" ]; then
            echo "File $(basename $file) exists in CMA. Replacing it."
            mv -f "$file" "$TARGET_FOLDER/CMA/"  # Replace the existing file
          else
            echo "File $(basename $file) does not exist in CMA. Moving it."
            mv "$file" "$TARGET_FOLDER/CMA/"  # Move the new file
          fi
        done

    - name: Cleanup unorganized files
      run: |
        # Delete files that are left in the root of the TARGET_FOLDER
        echo "Cleaning up unorganized files in $TARGET_FOLDER"
        
        # Find all files that are still in the root of the target folder and delete them
        find "$TARGET_FOLDER" -maxdepth 1 -type f -exec rm -f {} \;

    - name: Debug the directory contents
      run: |
        # List the files in the subfolders to ensure files were moved successfully
        echo "Listing files in $TARGET_FOLDER/Technical_Design:"
        ls "$TARGET_FOLDER/Technical_Design/"
        
        echo "Listing files in $TARGET_FOLDER/Functional_Design:"
        ls "$TARGET_FOLDER/Functional_Design/"
        
        echo "Listing files in $TARGET_FOLDER/Scripts:"
        ls "$TARGET_FOLDER/Scripts/"
        
        echo "Listing files in $TARGET_FOLDER/CMA:"
        ls "$TARGET_FOLDER/CMA/"

    - name: Commit and push changes
      run: |
        # Check if files were moved, and add only the moved files
        echo "Adding files to Git:"
        git add "$TARGET_FOLDER/Technical_Design/*" "$TARGET_FOLDER/Functional_Design/*" "$TARGET_FOLDER/Scripts/*" "$TARGET_FOLDER/CMA/*" || true
        
        # Commit the changes if there are any
        git commit -m "Organized files in $TARGET_FOLDER" || echo "No changes to commit"
        
        # Push the changes to the repository
        git push origin HEAD:develop  # Push to the main branch (adjust if using a different branch)
      env:
        # GitHub token is automatically provided to authenticate the push
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: List organized files in specific folder (Final Check)
      run: |
        # List the contents of the subfolders in the target folder after the commit
        echo "Files in $TARGET_FOLDER/Technical_Design:"
        ls "$TARGET_FOLDER/Technical_Design/"
        
        echo "Files in $TARGET_FOLDER/Functional_Design:"
        ls "$TARGET_FOLDER/Functional_Design/"
        
        echo "Files in $TARGET_FOLDER/Scripts:"
        ls "$TARGET_FOLDER/Scripts/"
        
        echo "Files in $TARGET_FOLDER/CMA:"
        ls "$TARGET_FOLDER/CMA/"
